@using System.Linq.Expressions
@model VerifyPackageRequest
@{
    ViewBag.Title = "Upload";
    ViewBag.Tab = "Upload";
}

<h1 class="page-heading">Verify Details &amp; Submit</h1>

@ViewHelpers.UploadSequence(2)

<h2>Verify Details</h2>
<p class="long note">
    Your package was successfully uploaded, but it is not yet submitted to the gallery. The package's metadata 
    was read and it is shown below.  Please verify the details and make any necessary changes before clicking submit.
    The ID, Version, and License URL cannot be edited without canceling and uploading a corrected package file.
</p>

@helper ReadOnlyField(string name, string formid, string value, bool link = false)
{
    <h4>@name</h4>
    if (String.IsNullOrEmpty(value))
    {
        <p><i>(none specified)</i></p>
    }
    else if (link)
    {
        <p><a href="@value">@value</a></p>
    }
    else
    {
        <p>@value</p>
    }
    <input type="hidden" name="formid" value="@value" />
}

@helper EditableField(string name, Expression<Func<VerifyPackageRequest, object>> func, bool link = false, bool multiline = false)
{
    var formid = ExpressionHelper.GetExpressionText(func).Replace(".", "_");
    object temp = func.Compile().Invoke(Model);
    string value = temp == null ? null : temp.ToString();
    <h4>@name
        <button type="button" class="edit-button" id="@(formid + "Button")"></button>
        <button type="button" class="undobutton" id="@("Undo" + formid)" style="display: none">Undo</button></h4>
    <div style="position: relative">
        <div id="@(formid + "Text")">
            @if (String.IsNullOrEmpty(value))
            {
                <p><i>(none specified)</i></p>
            }
            else if (link)
            {
                <p><a href="@value">@value</a></p>
            }
            else
            {
                <p>@value</p>
            }
        </div>
        <div id="@(formid +"Field")" style="display: none; width: 100%">
            <div class="form-field" style="display: inline">
                @Html.EditorFor(func)
                @Html.ValidationMessageFor(func)
            </div>
        </div>
    </div>
}

@using (Html.BeginForm(null, null, FormMethod.Post, new { id = "VerifyForm" }))
{
    <fieldset class="form">
        <legend>XXX</legend>
    <ul id="packageDetails" style="border-bottom: 1px solid gray; margin-bottom: 1em;">
        <li>@ReadOnlyField("Package ID", "Id", Model.Id)</li>
        <li>@ReadOnlyField("Version", "Version", Model.Version)</li>
        <li>@ReadOnlyField("License URL", "LicenseUrl", Model.LicenseUrl, link: true)</li>

        <li>@EditableField("Title", m => m.Edit.VersionTitle)</li>
        <li>@EditableField("Description", m => m.Edit.Description, multiline: true)</li>
        <li>@EditableField("Summary", m => m.Edit.Summary, multiline: true)</li>
        <li>@EditableField("Project URL", m => m.Edit.ProjectUrl, link: true)</li>
        <li>@EditableField("Authors", m => m.Edit.Authors)</li>
        <li>@EditableField("Copyright", m => m.Edit.Copyright)</li>
        <li>@EditableField("Tags", m => m.Edit.Tags, link: true)</li>
        <li>
            <h4>Requires License Acceptance
                <button type="button" class="edit-button" id="EditRequiresLicenseAcceptance"></button>
                <button type="button" class="undobutton" id="UndoEditRequiresLicenseAcceptance" style="display: none">Undo</button></h4>
            <div style="position: relative">
                <div id="RequiresLicenseAcceptanceText">
                    <p>@(Model.Edit.RequiresLicenseAcceptance ? "Yes" : "No")</p>
                </div>
                <div id="RequiresLicenseAcceptanceField" style="display: none; width: 100%">
                    <div class="form-field" style="display: inline">
                        @Html.DropDownList("RequiresLicenseAcceptance", 
                            new List<SelectListItem>
                            {
                                new SelectListItem { Text = "Yes", Value = "true" },
                                new SelectListItem { Text = "No", Value = "false" },
                            })
                        @Html.ValidationMessageFor(model => model.Edit.RequiresLicenseAcceptance)
                    </div>
                </div>
            </div>
        </li>
        @*<li>
            <h3>License URL</h3>
            @if (Model.LicenseUrl != null)
            {
                <a href="@Model.LicenseUrl" target="_blank">@Model.LicenseUrl</a>
            }
            else
            {
                <p><i>(No license URL. People may assume they have no license to use your package!)</i></p>
            }
        </li>*@
        @*<li>
            <h3>Description</h3>
            <div style="position: relative">
                <div id="DescriptionText">
                    <p>@(String.IsNullOrEmpty(Model.Description) ? "(blank)" : Model.Description) <button type="button" class="edit-button" id="EditDescription"></button></p>
                </div>
                <div id="DescriptionField" style="display: none; width: 100%">
                    <div class="form-field" style="display: inline">
                        @Html.TextAreaFor(model => model.Description)
                        @Html.ValidationMessageFor(model => model.Description)
                    </div>
                    <button type="button" class="undobutton" id="UndoEditDescription" style="display: none">Undo</button>
                </div>
            </div>
        </li>*@
        @*<li>
            <h3>Project URL</h3>
            <div style="position: relative">
                <div id="ProjectUrlText">
                    <p>@(String.IsNullOrEmpty(Model.ProjectUrl) ? "(blank)" : Model.ProjectUrl) <button type="button" class="edit-button" id="EditProjectUrl"></button></p>
                </div>
                <div id="ProjectUrlField" style="display: none; width: 100%">
                    <div class="form-field" style="display: inline">
                        @Html.TextBoxFor(model => model.ProjectUrl)
                        @Html.ValidationMessageFor(model => model.ProjectUrl)
                    </div>
                    <button type="button" class="undobutton" id="UndoEditProjectUrl" style="display: none">Undo</button>
                </div>
            </div>
        </li>*@
        @*<li>
            <div title="These authors' works form part of the package or its contents">
                <h3>Authors</h3>
                <div style="position: relative">
                    <div id="AuthorsText">
                        <p>@(String.IsNullOrEmpty(Model.Authors) ? "(blank)" : Model.Authors) <button type="button" class="edit-button" id="EditAuthors"></button></p>
                    </div>
                    <div id="AuthorsField" title="" style="display: none; width: 100%">
                        <div class="form-field" style="display: inline">
                            @Html.TextBoxFor(model => model.Authors)
                            @Html.ValidationMessageFor(model => model.Authors)
                        </div>
                        <button type="button" class="undobutton" id="UndoEditAuthors" style="display: none">Undo</button>
                    </div>
                </div>
            </div>
        </li>*@
        @*<li>
            <h3>Copyright</h3>
            <div style="position: relative">
                <div id="CopyrightText">
                    <p>@(String.IsNullOrEmpty(Model.Copyright) ? "(blank)" : Model.Copyright) <button type="button" class="edit-button" id="EditCopyright"></button></p>
                </div>
                <div id="CopyrightField" style="display: none; width: 100%">
                    <div class="form-field" style="display: inline">
                        @Html.TextBoxFor(model => model.Copyright)
                        @Html.ValidationMessageFor(model => model.Copyright)
                    </div>
                    <button type="button" class="undobutton" id="UndoEditCopyright" style="display: none">Undo</button>
                </div>
            </div>
        </li>*@
        @*<li>
            <h3>Tags</h3>
            <div style="position: relative">
                <div id="TagsText">
                    <p>@(String.IsNullOrEmpty(Model.Tags) ? "(blank)" : Model.Tags) <button type="button" class="edit-button" id="EditTags"></button></p>
                </div>
                <div id="TagsField" style="display: none; width: 100%">
                    <div class="form-field" style="display: inline">
                        @Html.TextBoxFor(model => model.Tags)
                        @Html.ValidationMessageFor(model => model.Tags)
                    </div>
                    <button type="button" class="undobutton" id="UndoEditTags" style="display: none">Undo</button>
                </div>
            </div>
        </li>*@
        <li>
            <h4>List This Package in Search Results</h4>
                <div class="form-field">
                    <select>
                        <option>Yes</option>
                        <option>No</option>
                    </select>
                    <!--
                    @Html.EditorFor(package => package.Listed)
                    <label for="Listed" class="checkbox">
                        List this package in search results. 
                    </label>
                    -->
                </div>
        </li>
    </ul>

    @Html.AntiForgeryToken()
    <input type="submit" value="Submit" title="Verify Details &amp; Submit" /> 
    <a class="cancel" href="@Url.CancelUpload()" title="Cancel the upload in progress.">Cancel</a>
</fieldset>
}

@section BottomScripts {
    <script>
        $(function() {
            $('a.cancel').click(function() {
                var $anchor = $(this);
                var $form = $anchor.parents('form');
                $form.attr('action', $anchor.attr('href'));
                $form.submit();
                return false;
            });
        });
        $(function () {
            var form = $('#VerifyForm').toArray()[0];
            $(".edit-button").click(function (event) {
                event.preventDefault();
            });

            function SetupInput(name) {
                $("#" + name + "Button").click(function (event) {
                    event.preventDefault();
                    $("#" + name + "Text").css("visibility", "hidden");
                    $("#" + name + "Text").css("position", "absolute");
                    $("#" + name + "Field").show();
                    $("#" + name + "Button").hide();
                    $("#Undo" + name).show();
                });

                $("input[name=" + name + "]").keyup(function (event) {
                    $(event.target).attr("data-edited", event.target.value != event.target.defaultValue);
                    $("#Undo" + name).show();
                });
                $("textarea[name=" + name + "]").keyup(function (event) {
                    $(event.target).attr("data-edited", event.target.value != event.target.defaultValue);
                    $("#Undo" + name).show();
                });

                $("#Undo" + name + "").click(function (event) {
                    event.preventDefault();
                    $(document.forms.VerifyForm.elements["" + name + ""]).each(function () {
                        this.value = this.defaultValue;
                        $(this).attr("data-edited", "false");
                    });
                    $(event.target).hide();
                    $("#" + name + "Text").css("position", "static");
                    $("#" + name + "Text").css("visibility", "inherit");
                    $("#" + name + "Field").hide();
                    $("#" + name + "Button").show();
                    $("#Undo" + name).hide();
                });
            }

            SetupInput('Edit.VersionTitle');
            SetupInput('Edit.Description');
            SetupInput('Edit.Summary');
            SetupInput('Edit.ProjectUrl');
            SetupInput('Edit.Authors');
            SetupInput('Edit.Copyright');
            SetupInput('Edit.Tags');
            SetupInput('Edit.RequiresLicenseAcceptance');

            //$("#EditTitle").click(function (event) {
            //    event.preventDefault();
            //    $("#TitleText").css("visibility", "hidden");
            //    $("#TitleText").css("position", "absolute");
            //    $("#TitleField").show();
            //    $("#UndoEditTitle").hide();
            //});
            //$("#UndoEditTitle").click(function (event) {
            //    event.preventDefault();
            //    $(document.forms.VerifyForm.elements["Title"]).each(function () { this.value = this.defaultValue; });
            //    $("#TitleText").css("position", "static");
            //    $("#TitleText").css("visibility", "inherit");
            //    $("#TitleField").hide();
            //});

            //$("#EditDescription").click(function (event) {
            //    event.preventDefault();
            //    $("#DescriptionText").css("visibility", "hidden");
            //    $("#DescriptionText").css("position", "absolute");
            //    $("#DescriptionField").show();
            //    $("#UndoEditDescription").hide();
            //});
            //$("textarea[name=Description]").change(function (event) {
            //    $("#UndoEditDescription").show();
            //});
            //$("#UndoEditDescription").click(function (event) {
            //    event.preventDefault();
            //    $(document.forms.VerifyForm.elements["Description"]).each (function () { this.value = this.defaultValue; });
            //    $("#DescriptionText").css("visibility", "inherit");
            //    $("#DescriptionText").css("position", "static");
            //    $("#DescriptionField").hide();
            //});
        });
    </script>
}
